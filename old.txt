import { useState, useRef, useEffect } from "react";
import { LineChart, Line, BarChart, Bar, PieChart, Pie, Cell, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, AreaChart, Area, RadarChart, Radar, PolarGrid, PolarAngleAxis } from "recharts";

// ── ANALYTICS DATA (pre-computed from 250,000 UPI transactions 2024) ──────────
const DATA = {
  total_transactions: 250000,
  total_volume: 327939009,
  avg_amount: 1311.76,
  fraud_count: 480,
  fraud_rate: 0.192,
  success_rate: 95.05,
  categories: { Grocery: 49966, Food: 37464, Shopping: 29872, Fuel: 25063, Other: 24828, Utilities: 22338, Transport: 20105, Entertainment: 20103, Healthcare: 12663, Education: 7598 },
  states: { Maharashtra: 37427, "Uttar Pradesh": 30125, Karnataka: 29756, "Tamil Nadu": 25367, Delhi: 24870, Telangana: 22435, Gujarat: 20061, "Andhra Pradesh": 20006, Rajasthan: 19981, "West Bengal": 19972 },
  devices: { Android: 187777, iOS: 49613, Web: 12610 },
  networks: { "4G": 149813, "5G": 62582, WiFi: 25134, "3G": 12471 },
  banks: { SBI: 62693, HDFC: 37485, ICICI: 29769, IndusInd: 25173, Axis: 25042, PNB: 24946, "Yes Bank": 24860, Kotak: 20032 },
  tx_types: { P2P: 112445, P2M: 87660, "Bill Payment": 37368, Recharge: 12527 },
  age_groups: { "26-35": 87432, "36-45": 62873, "18-25": 62345, "46-55": 24841, "56+": 12509 },
  hourly: {
    sum: { 0: 4532884, 1: 2914350, 2: 2173750, 3: 1678669, 4: 1670700, 5: 2134122, 6: 4617034, 7: 7482766, 8: 10979614, 9: 13809021, 10: 18337313, 11: 21193161, 12: 23406280, 13: 19847819, 14: 14848621, 15: 16658144, 16: 17921125, 17: 24514186, 18: 26297174, 19: 28223522, 20: 23822014, 21: 20995491, 22: 12050824, 23: 7830425 },
    count: { 0: 3388, 1: 2244, 2: 1685, 3: 1314, 4: 1247, 5: 1742, 6: 3501, 7: 5630, 8: 8349, 9: 10450, 10: 13904, 11: 16328, 12: 17516, 13: 15038, 14: 11472, 15: 12624, 16: 13992, 17: 18340, 18: 20064, 19: 21232, 20: 18506, 21: 16253, 22: 9364, 23: 5817 }
  },
  daily: {
    count: { Monday: 36495, Tuesday: 35540, Wednesday: 35700, Thursday: 35432, Friday: 35496, Saturday: 35334, Sunday: 36003 },
    sum: { Monday: 47882908, Tuesday: 46846390, Wednesday: 46815663, Thursday: 46620985, Friday: 46332583, Saturday: 45867936, Sunday: 47572544 }
  },
  cat_fraud: { Education: 0.211, Entertainment: 0.199, Food: 0.195, Fuel: 0.192, Grocery: 0.188, Healthcare: 0.166, Other: 0.201, Shopping: 0.208, Transport: 0.214, Utilities: 0.148 },
  state_vol: { "Andhra Pradesh": 25952619, Delhi: 32689865, Gujarat: 25988190, Karnataka: 38451158, Maharashtra: 49043948, Rajasthan: 26730470, "Tamil Nadu": 33343518, Telangana: 29750930, "Uttar Pradesh": 40035717, "West Bengal": 25952594 },
  state_fraud: { "Andhra Pradesh": 0.175, Delhi: 0.201, Gujarat: 0.214, Karnataka: 0.232, Maharashtra: 0.19, Rajasthan: 0.23, "Tamil Nadu": 0.158, Telangana: 0.174, "Uttar Pradesh": 0.173, "West Bengal": 0.175 },
  // ── DEVICE BREAKDOWN (full granular stats) ───────────────────────────────
  device_avg: { Android: 1313.98, iOS: 1306.10, Web: 1300.81 },
  device_median: { Android: 629, iOS: 632, Web: 615 },
  device_max: { Android: 42099, iOS: 30351, Web: 27541 },
  device_min: { Android: 10, iOS: 10, Web: 13 },
  device_std: { Android: 1852.41, iOS: 1831.36, Web: 1848.74 },
  device_total_vol: { Android: 246736086, iOS: 64799708, Web: 16403215 },
  device_p90: { Android: 3251, iOS: 3199, Web: 3185 },
  device_p95: { Android: 4700, iOS: 4634, Web: 4657 },
  device_fraud: { Android: 0.194, iOS: 0.181, Web: 0.206 },
  device_fraud_count: { Android: 364, iOS: 90, Web: 26 },
  device_fail_rate: { Android: 4.94, iOS: 4.93, Web: 5.15 },
  device_success_rate: { Android: 95.06, iOS: 95.07, Web: 94.85 },
  device_cat_avg: {
    Education: { Android: 5093.24, iOS: 5116.23, Web: 5026.92 },
    Entertainment: { Android: 413.77, iOS: 413.07, Web: 407.67 },
    Food: { Android: 528.78, iOS: 542.16, Web: 534.71 },
    Fuel: { Android: 1555.57, iOS: 1554.83, Web: 1554.80 },
    Grocery: { Android: 1169.67, iOS: 1161.03, Web: 1137.12 },
    Healthcare: { Android: 545.10, iOS: 542.35, Web: 511.03 },
    Other: { Android: 847.00, iOS: 847.86, Web: 878.38 },
    Shopping: { Android: 2592.11, iOS: 2524.61, Web: 2482.87 },
    Transport: { Android: 308.79, iOS: 303.56, Web: 314.01 },
    Utilities: { Android: 2355.59, iOS: 2384.35, Web: 2353.66 },
  },
  device_cat_count: {
    Education: { Android: 5710, iOS: 1468, Web: 420 },
    Entertainment: { Android: 15098, iOS: 4005, Web: 1000 },
    Food: { Android: 28224, iOS: 7315, Web: 1925 },
    Fuel: { Android: 18679, iOS: 5119, Web: 1265 },
    Grocery: { Android: 37575, iOS: 9933, Web: 2458 },
    Healthcare: { Android: 9519, iOS: 2513, Web: 631 },
    Other: { Android: 18671, iOS: 4887, Web: 1270 },
    Shopping: { Android: 22392, iOS: 5960, Web: 1520 },
    Transport: { Android: 15016, iOS: 4054, Web: 1035 },
    Utilities: { Android: 16893, iOS: 4359, Web: 1086 },
  },
  device_type_avg: {
    "Bill Payment": { Android: 1316.39, iOS: 1295.81, Web: 1242.09 },
    P2M: { Android: 1322.24, iOS: 1314.79, Web: 1308.27 },
    P2P: { Android: 1308.79, iOS: 1305.66, Web: 1319.16 },
    Recharge: { Android: 1295.46, iOS: 1280.34, Web: 1265.61 },
  },
  device_type_count: {
    "Bill Payment": { Android: 28056, iOS: 7387, Web: 1925 },
    P2M: { Android: 65998, iOS: 17269, Web: 4393 },
    P2P: { Android: 84336, iOS: 22474, Web: 5635 },
    Recharge: { Android: 9387, iOS: 2483, Web: 657 },
  },
  device_age_avg: {
    "18-25": { Android: 1201.53, iOS: 1168.86, Web: 1191.27 },
    "26-35": { Android: 1327.19, iOS: 1321.48, Web: 1331.86 },
    "36-45": { Android: 1425.21, iOS: 1434.02, Web: 1366.95 },
    "46-55": { Android: 1334.97, iOS: 1334.33, Web: 1300.00 },
    "56+": { Android: 1181.88, iOS: 1181.60, Web: 1300.66 },
  },
  device_age_count: {
    "18-25": { Android: 46848, iOS: 12338, Web: 3159 },
    "26-35": { Android: 65466, iOS: 17482, Web: 4484 },
    "36-45": { Android: 47288, iOS: 12442, Web: 3143 },
    "46-55": { Android: 18724, iOS: 4898, Web: 1219 },
    "56+": { Android: 9451, iOS: 2453, Web: 605 },
  },
  device_network_avg: {
    "3G": { Android: 1327.83, iOS: 1292.18, Web: 1423.75 },
    "4G": { Android: 1308.72, iOS: 1303.85, Web: 1271.55 },
    "5G": { Android: 1315.32, iOS: 1318.22, Web: 1318.57 },
    WiFi: { Android: 1335.11, iOS: 1296.23, Web: 1367.16 },
  },
  device_network_count: {
    "3G": { Android: 9441, iOS: 2394, Web: 636 },
    "4G": { Android: 112413, iOS: 29881, Web: 7519 },
    "5G": { Android: 47058, iOS: 12359, Web: 3165 },
    WiFi: { Android: 18865, iOS: 4979, Web: 1290 },
  },
  bucket_Android: { "< ₹100": 9825, "₹100–500": 70156, "₹500–1K": 38275, "₹1K–5K": 61244, "₹5K–10K": 6924, "> ₹10K": 1353 },
  bucket_iOS: { "< ₹100": 2609, "₹100–500": 18413, "₹500–1K": 10278, "₹1K–5K": 16178, "₹5K–10K": 1771, "> ₹10K": 364 },
  bucket_Web: { "< ₹100": 665, "₹100–500": 4794, "₹500–1K": 2582, "₹1K–5K": 4022, "₹5K–10K": 459, "> ₹10K": 88 },
  device_weekend_avg: { Android: 1309.56, iOS: 1314.12, Web: 1297.12 },
  device_weekday_avg: { Android: 1315.75, iOS: 1302.89, Web: 1302.26 },
  network_fraud: { "3G": 0.192, "4G": 0.188, "5G": 0.184, WiFi: 0.235 },
  cat_avg: { Education: 5094.02, Entertainment: 413.33, Food: 531.69, Fuel: 1555.38, Grocery: 1166.35, Healthcare: 542.85, Other: 848.78, Shopping: 2573.09, Transport: 308.0, Utilities: 2361.11 },
  cat_vol: { Education: 38704346, Entertainment: 8309080, Food: 19919402, Fuel: 38982575, Grocery: 58277893, Healthcare: 6874159, Other: 21073449, Shopping: 76863207, Transport: 6192416, Utilities: 52742482 },
  bank_fraud: { Axis: 0.196, HDFC: 0.165, ICICI: 0.222, IndusInd: 0.207, Kotak: 0.25, PNB: 0.208, SBI: 0.174, "Yes Bank": 0.161 },
  age_fraud: { "18-25": 0.229, "26-35": 0.186, "36-45": 0.184, "46-55": 0.125, "56+": 0.216 },
  age_avg: { "18-25": 1194.55, "26-35": 1326.29, "36-45": 1424.04, "46-55": 1333.13, "56+": 1187.57 },
  type_fraud: { "Bill Payment": 0.206, P2M: 0.191, P2P: 0.183, Recharge: 0.239 },
  type_avg: { "Bill Payment": 1308.49, P2M: 1320.07, P2P: 1308.68, Recharge: 1290.9 },
  cat_fail: { Education: 5.25, Entertainment: 4.92, Food: 5.01, Fuel: 4.8, Grocery: 5.01, Healthcare: 4.83, Other: 4.95, Shopping: 5.09, Transport: 4.76, Utilities: 4.86 },
  peak_hour: 19,
  top_state: "Maharashtra",
  top_cat: "Grocery",

  // ── GRANULAR AMOUNT STATS ─────────────────────────────────────────────────
  max_amount: 42099,
  min_amount: 10,
  median_amount: 629,
  std_amount: 1848.06,
  p90_amount: 3236,
  p95_amount: 4687,
  p99_amount: 9003,

  // Amount distribution buckets
  amount_buckets: { "< ₹100": 13099, "₹100–500": 93363, "₹500–1K": 51135, "₹1K–5K": 81444, "₹5K–10K": 9154, "> ₹10K": 1805 },

  // Top 10 highest transactions
  top10_amounts: [
    { amount: 42099, category: "Education", type: "P2P", state: "Telangana", device: "Android", network: "4G", status: "FAILED", fraud: 0, hour: 1, day: "Sunday" },
    { amount: 41210, category: "Education", type: "Bill Payment", state: "Maharashtra", device: "Android", network: "4G", status: "SUCCESS", fraud: 0, hour: 14, day: "Saturday" },
    { amount: 37263, category: "Education", type: "Recharge", state: "Rajasthan", device: "Android", network: "WiFi", status: "SUCCESS", fraud: 0, hour: 22, day: "Tuesday" },
    { amount: 34304, category: "Education", type: "P2P", state: "Andhra Pradesh", device: "Android", network: "5G", status: "SUCCESS", fraud: 0, hour: 17, day: "Friday" },
    { amount: 33061, category: "Education", type: "P2P", state: "Rajasthan", device: "Android", network: "WiFi", status: "SUCCESS", fraud: 0, hour: 23, day: "Monday" },
    { amount: 32741, category: "Education", type: "P2P", state: "West Bengal", device: "Android", network: "WiFi", status: "SUCCESS", fraud: 0, hour: 17, day: "Friday" },
    { amount: 30584, category: "Education", type: "P2P", state: "Andhra Pradesh", device: "Android", network: "5G", status: "SUCCESS", fraud: 0, hour: 20, day: "Wednesday" },
    { amount: 30351, category: "Utilities", type: "P2P", state: "West Bengal", device: "iOS", network: "WiFi", status: "SUCCESS", fraud: 0, hour: 23, day: "Wednesday" },
    { amount: 30112, category: "Education", type: "P2M", state: "Telangana", device: "Android", network: "5G", status: "SUCCESS", fraud: 0, hour: 21, day: "Monday" },
    { amount: 29601, category: "Education", type: "P2M", state: "Uttar Pradesh", device: "Android", network: "3G", status: "SUCCESS", fraud: 0, hour: 7, day: "Tuesday" },
  ],

  // Per-category amount stats
  cat_max: { Education: 42099, Entertainment: 5289, Food: 6409, Fuel: 8468, Grocery: 9611, Healthcare: 8485, Other: 19289, Shopping: 27259, Transport: 5171, Utilities: 30351 },
  cat_min: { Education: 215, Entertainment: 34, Food: 10, Fuel: 134, Grocery: 33, Healthcare: 49, Other: 31, Shopping: 32, Transport: 10, Utilities: 47 },
  cat_median: { Education: 3670, Entertainment: 294, Food: 332, Fuel: 1037, Grocery: 821, Other: 615, Healthcare: 384, Food: 332, Entertainment: 294, Transport: 189, Utilities: 1864 },
  cat_p95: { Education: 14173, Entertainment: 1116, Food: 1690, Fuel: 4096, Grocery: 3230, Healthcare: 1496, Other: 2303, Shopping: 7826, Transport: 921, Utilities: 6521 },

  // Per-state amount stats
  state_max: { "Andhra Pradesh": 34304, Delhi: 28783, Gujarat: 28544, Karnataka: 25396, Maharashtra: 41210, Rajasthan: 37263, "Tamil Nadu": 26992, Telangana: 42099, "Uttar Pradesh": 29601, "West Bengal": 32741 },
  state_median: { "Andhra Pradesh": 621, Delhi: 630, Gujarat: 642, Karnataka: 625, Maharashtra: 631, Rajasthan: 636, "Tamil Nadu": 626, Telangana: 631, "Uttar Pradesh": 625, "West Bengal": 624 },

  // Per-bank amount stats
  bank_max: { Axis: 37263, HDFC: 41210, ICICI: 28544, IndusInd: 42099, Kotak: 30584, PNB: 34304, SBI: 29601, "Yes Bank": 33061 },
  bank_avg: { Axis: 1296.72, HDFC: 1328.30, ICICI: 1301.06, IndusInd: 1304.68, Kotak: 1313.67, PNB: 1301.89, SBI: 1320.99, "Yes Bank": 1307.02 },

  // Per-device amount stats
  device_max: { Android: 42099, Web: 27541, iOS: 30351 },
  device_avg: { Android: 1313.98, Web: 1300.81, iOS: 1306.10 },

  // Per-type amount stats
  type_max: { "Bill Payment": 41210, P2M: 30112, P2P: 42099, Recharge: 37263 },
  type_min: { "Bill Payment": 10, P2M: 12, P2P: 10, Recharge: 17 },
  type_median: { "Bill Payment": 629, P2M: 632, P2P: 628, Recharge: 618 },

  // Per-age amount stats
  age_max: { "18-25": 25881, "26-35": 41210, "36-45": 37263, "46-55": 42099, "56+": 22081 },
  age_median: { "18-25": 611, "26-35": 641, "36-45": 657, "46-55": 603, "56+": 552 },

  // Network amount stats
  network_max: { "3G": 29601, "4G": 42099, "5G": 34304, WiFi: 37263 },
  network_avg: { "3G": 1325.88, "4G": 1305.88, "5G": 1316.06, WiFi: 1329.05 },

  // High-value transactions (>₹10K)
  high_value_count: 1805,
  high_value_by_cat: { Education: 960, Shopping: 573, Utilities: 266, Other: 6 },
  high_value_by_state: { Maharashtra: 271, "Uttar Pradesh": 238, "Tamil Nadu": 205, Karnataka: 195, Delhi: 179, Telangana: 168, Rajasthan: 164, "West Bengal": 132, "Andhra Pradesh": 129, Gujarat: 124 },
  high_value_fraud_rate: 0.332,

  // Fraud transaction amount stats
  fraud_avg_amount: 1499.23,
  fraud_max_amount: 17718,
  fraud_min_amount: 28,
  fraud_median_amount: 618.5,

  // Weekend vs weekday max
  weekend_max: 42099,
  weekday_max: 37263,
};

// ── WHITE & BLUE THEME ─────────────────────────────────
const THEME = {
  bg: "#f8fafc",              // app background (very light slate)
  surface: "#ffffff",         // cards & panels (pure white)
  surfaceHover: "#f1f5f9",    // hover state
  border: "#e2e8f0",          // light gray borders
  borderSoft: "#cbd5e1",      // slightly stronger borders
  
  textPrimary: "#1e293b",     // dark slate (high contrast)
  textSecondary: "#64748b",   // muted blue-gray
  textLight: "#94a3b8",       // very light text
  
  blue: "#2563eb",            // Primary Royal Blue
  blueLight: "#3b82f6",       // Lighter Blue
  blueSoft: "#dbeafe",        // Light blue background
  bluePale: "#eff6ff",        // Very pale blue background
  
  accent: "#0ea5e9",          // Sky blue accent
  danger: "#ef4444",          // Red for alerts
  success: "#10b981",         // Green for success
  warning: "#f59e0b",         // Orange/Amber
  
  chartGrid: "#f1f5f9",       // Light gray grid for charts
  chartText: "#64748b",       // Chart axis text
  
  gradient: "linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%)"
};

// ── HELPERS ───────────────────────────────────────────────────────────────────
const fmt = (n) => n >= 1e7 ? `₹${(n / 1e7).toFixed(1)}Cr` : n >= 1e5 ? `₹${(n / 1e5).toFixed(1)}L` : n >= 1000 ? `₹${(n / 1000).toFixed(1)}K` : `₹${n}`;
const fmtNum = (n) => n >= 1e6 ? `${(n / 1e6).toFixed(1)}M` : n >= 1e3 ? `${(n / 1e3).toFixed(1)}K` : n;
const COLORS = ["#2563eb", "#3b82f6", "#0ea5e9", "#06b6d4", "#10b981", "#f59e0b", "#ef4444", "#8b5cf6", "#6366f1", "#ec4899"];
const CHART_COLORS = { primary: "#2563eb", secondary: "#3b82f6", accent: "#0ea5e9", danger: "#ef4444", success: "#10b981" };

// Build chart datasets
const hourlyChartData = Array.from({ length: 24 }, (_, h) => ({ hour: `${h}:00`, volume: Math.round(DATA.hourly.sum[h] / 1e6 * 10) / 10, txns: DATA.hourly.count[h] }));
const dailyChartData = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"].map(d => ({ day: d.slice(0, 3), volume: Math.round(DATA.daily.sum[d] / 1e6), txns: DATA.daily.count[d] }));
const catChartData = Object.entries(DATA.categories).map(([k, v]) => ({ name: k, txns: v, volume: Math.round((DATA.cat_vol[k] || 0) / 1e6), avg: DATA.cat_avg[k] || 0, fraud: DATA.cat_fraud[k] || 0, fail: DATA.cat_fail[k] || 0 })).sort((a, b) => b.txns - a.txns);
const stateChartData = Object.entries(DATA.state_vol).map(([k, v]) => ({ state: k.replace(" Pradesh", "").replace("Tamil Nadu", "TN").replace("West Bengal", "WB"), vol: Math.round(v / 1e6), fraud: DATA.state_fraud[k] || 0, txns: DATA.states[k] || 0 })).sort((a, b) => b.vol - a.vol);
const devicePieData = Object.entries(DATA.devices).map(([k, v]) => ({ name: k, value: v }));
const networkPieData = Object.entries(DATA.networks).map(([k, v]) => ({ name: k, value: v }));
const bankChartData = Object.entries(DATA.banks).map(([k, v]) => ({ bank: k, txns: v, fraud: DATA.bank_fraud[k] || 0 })).sort((a, b) => b.txns - a.txns);
const fraudByType = Object.entries(DATA.type_fraud).map(([k, v]) => ({ type: k, fraud: v, avg: DATA.type_avg[k] }));

// ── SYSTEM PROMPT FOR AI ──────────────────────────────────────────────────────
const buildSystemPrompt = () => `You are InsightX AI — a conversational business intelligence assistant for a 250,000-row UPI digital payments dataset (India, 2024). You help non-technical business leaders understand their payment data through natural language.

DATASET FACTS:
- Total transactions: 250,000 | Total volume: ₹32.79 Crore | Success rate: 95.05%
- Avg: ₹1,311.76 | Median: ₹629 | Min: ₹10 | Max: ₹42,099 | Std Dev: ₹1,848
- 90th pct: ₹3,236 | 95th pct: ₹4,687 | 99th pct: ₹9,003
- Fraud rate: 0.192% (480 cases) | Date range: 2024 full year

AMOUNT DISTRIBUTION:
Under ₹100: 13,099 (5.2%) | ₹100–500: 93,363 (37.3%) | ₹500–1K: 51,135 (20.5%) | ₹1K–5K: 81,444 (32.6%) | ₹5K–10K: 9,154 (3.7%) | Above ₹10K: 1,805 (0.72%)

TOP 10 HIGHEST INDIVIDUAL TRANSACTIONS:
1. ₹42,099 — Education, P2P, Telangana, Android/4G, FAILED, 1 AM Sunday
2. ₹41,210 — Education, Bill Payment, Maharashtra, Android/4G, SUCCESS, 2 PM Saturday
3. ₹37,263 — Education, Recharge, Rajasthan, Android/WiFi, SUCCESS, 10 PM Tuesday
4. ₹34,304 — Education, P2P, Andhra Pradesh, Android/5G, SUCCESS, 5 PM Friday
5. ₹33,061 — Education, P2P, Rajasthan, Android/WiFi, SUCCESS, 11 PM Monday
6. ₹32,741 — Education, P2P, West Bengal, Android/WiFi, SUCCESS, 5 PM Friday
7. ₹30,584 — Education, P2P, Andhra Pradesh, Android/5G, SUCCESS, 8 PM Wednesday
8. ₹30,351 — Utilities, P2P, West Bengal, iOS/WiFi, SUCCESS, 11 PM Wednesday
9. ₹30,112 — Education, P2M, Telangana, Android/5G, SUCCESS, 9 PM Monday
10. ₹29,601 — Education, P2M, Uttar Pradesh, Android/3G, SUCCESS, 7 AM Tuesday

MAX AMOUNTS BY CATEGORY: Education ₹42,099 | Utilities ₹30,351 | Shopping ₹27,259 | Other ₹19,289 | Healthcare ₹8,485 | Fuel ₹8,468 | Grocery ₹9,611 | Food ₹6,409 | Entertainment ₹5,289 | Transport ₹5,171
MIN AMOUNTS BY CATEGORY: Food ₹10 | Transport ₹10 | Shopping ₹32 | Grocery ₹33 | Entertainment ₹34 | Utilities ₹47 | Healthcare ₹49 | Fuel ₹134 | Education ₹215 | Other ₹31
MEDIAN BY CATEGORY: Education ₹3,670 | Utilities ₹1,864 | Shopping ₹1,564 | Fuel ₹1,037 | Grocery ₹821 | Other ₹615 | Healthcare ₹384 | Food ₹332 | Entertainment ₹294 | Transport ₹189
AVG BY CATEGORY: Education ₹5,094 | Shopping ₹2,573 | Utilities ₹2,361 | Fuel ₹1,555 | Grocery ₹1,166 | Other ₹849 | Healthcare ₹543 | Food ₹532 | Entertainment ₹413 | Transport ₹308

MAX BY STATE: Telangana ₹42,099 | Maharashtra ₹41,210 | Rajasthan ₹37,263 | Andhra Pradesh ₹34,304 | West Bengal ₹32,741 | Uttar Pradesh ₹29,601 | Delhi ₹28,783 | Gujarat ₹28,544 | Tamil Nadu ₹26,992 | Karnataka ₹25,396
MAX BY BANK: IndusInd ₹42,099 | HDFC ₹41,210 | Axis ₹37,263 | PNB ₹34,304 | Yes Bank ₹33,061 | Kotak ₹30,584 | SBI ₹29,601 | ICICI ₹28,544
MAX BY DEVICE: Android ₹42,099 | iOS ₹30,351 | Web ₹27,541
MAX BY NETWORK: 4G ₹42,099 | WiFi ₹37,263 | 5G ₹34,304 | 3G ₹29,601
MAX BY TX TYPE: P2P ₹42,099 | Bill Payment ₹41,210 | Recharge ₹37,263 | P2M ₹30,112
MAX BY AGE GROUP: 46-55 ₹42,099 | 26-35 ₹41,210 | 36-45 ₹37,263 | 18-25 ₹25,881 | 56+ ₹22,081

HIGH-VALUE (>₹10K): 1,805 transactions | Education 960 | Shopping 573 | Utilities 266 | Other 6
High-value fraud rate 0.332% — 73% higher than overall 0.192%

FRAUD TRANSACTION AMOUNTS: Avg ₹1,499 | Max ₹17,718 | Min ₹28 | Median ₹619
(Fraud avg is 14% higher than overall avg — fraudsters target slightly larger transactions)

TRANSACTION TYPES: P2P (112,445), P2M (87,660), Bill Payment (37,368), Recharge (12,527)
MERCHANT CATEGORIES (by count): Grocery 49,966 | Food 37,464 | Shopping 29,872 | Fuel 25,063 | Other 24,828 | Utilities 22,338 | Transport 20,105 | Entertainment 20,103 | Healthcare 12,663 | Education 7,598
TOP STATES BY VOLUME: Maharashtra ₹4.9Cr | Uttar Pradesh ₹4.0Cr | Karnataka ₹3.8Cr | Tamil Nadu ₹3.3Cr | Delhi ₹3.3Cr
DEVICES: Android 187,777 (75.1%) | iOS 49,613 (19.8%) | Web 12,610 (5.0%)

DEVICE AMOUNT STATS (exact figures from dataset):
- Android: avg ₹1,313.98 | median ₹629 | max ₹42,099 | min ₹10 | std ₹1,852 | p90 ₹3,251 | p95 ₹4,700 | vol ₹24.67Cr
- iOS:     avg ₹1,306.10 | median ₹632 | max ₹30,351 | min ₹10 | std ₹1,831 | p90 ₹3,199 | p95 ₹4,634 | vol ₹6.48Cr
- Web:     avg ₹1,300.81 | median ₹615 | max ₹27,541 | min ₹13 | std ₹1,849 | p90 ₹3,185 | p95 ₹4,657 | vol ₹1.64Cr

DEVICE FRAUD & RELIABILITY:
- Android: fraud 0.194% (364 cases) | fail rate 4.94% | success 95.06%
- iOS:     fraud 0.181% (90 cases)  | fail rate 4.93% | success 95.07%  ← SAFEST
- Web:     fraud 0.206% (26 cases)  | fail rate 5.15% | success 94.85%  ← MOST RISKY

DEVICE × CATEGORY AVERAGE AMOUNTS:
- Education:     Android ₹5,093 | iOS ₹5,116 | Web ₹5,027   (iOS highest)
- Shopping:      Android ₹2,592 | iOS ₹2,525 | Web ₹2,483   (Android highest)
- Utilities:     Android ₹2,356 | iOS ₹2,384 | Web ₹2,354   (iOS highest)
- Fuel:          Android ₹1,556 | iOS ₹1,555 | Web ₹1,555   (essentially equal)
- Grocery:       Android ₹1,170 | iOS ₹1,161 | Web ₹1,137   (Android highest)
- Healthcare:    Android ₹545   | iOS ₹542   | Web ₹511
- Food:          Android ₹529   | iOS ₹542   | Web ₹535      (iOS highest)
- Other:         Android ₹847   | iOS ₹848   | Web ₹878      (Web highest)
- Entertainment: Android ₹414   | iOS ₹413   | Web ₹408
- Transport:     Android ₹309   | iOS ₹304   | Web ₹314

DEVICE × TRANSACTION TYPE AVERAGES:
- P2M:          Android ₹1,322 | iOS ₹1,315 | Web ₹1,308
- P2P:          Android ₹1,309 | iOS ₹1,306 | Web ₹1,319
- Bill Payment: Android ₹1,316 | iOS ₹1,296 | Web ₹1,242
- Recharge:     Android ₹1,295 | iOS ₹1,280 | Web ₹1,266

DEVICE × AGE GROUP AVERAGES:
- 36-45: Android ₹1,425 | iOS ₹1,434 | Web ₹1,367  (iOS highest for this age)
- 26-35: Android ₹1,327 | iOS ₹1,321 | Web ₹1,332
- 46-55: Android ₹1,335 | iOS ₹1,334 | Web ₹1,300
- 18-25: Android ₹1,202 | iOS ₹1,169 | Web ₹1,191
- 56+:   Android ₹1,182 | iOS ₹1,182 | Web ₹1,301  (Web highest for seniors)

DEVICE AMOUNT DISTRIBUTION (% of each device's transactions):
- Android: <₹100: 5.2% | ₹100-500: 37.4% | ₹500-1K: 20.4% | ₹1K-5K: 32.6% | >₹10K: 0.72%
- iOS:     <₹100: 5.3% | ₹100-500: 37.1% | ₹500-1K: 20.7% | ₹1K-5K: 32.6% | >₹10K: 0.73%
- Web:     <₹100: 5.3% | ₹100-500: 38.0% | ₹500-1K: 20.5% | ₹1K-5K: 31.9% | >₹10K: 0.70%

DEVICE × NETWORK AVERAGE AMOUNTS:
- Android on WiFi: ₹1,335 | iOS on WiFi: ₹1,296 | Web on WiFi: ₹1,367
- Android on 5G: ₹1,315  | iOS on 5G: ₹1,318   | Web on 5G: ₹1,319
- Android on 4G: ₹1,309  | iOS on 4G: ₹1,304   | Web on 4G: ₹1,272
- Android on 3G: ₹1,328  | iOS on 3G: ₹1,292   | Web on 3G: ₹1,424 (Web 3G anomaly)

WEEKEND vs WEEKDAY by device:
- Android: weekend avg ₹1,310 | weekday avg ₹1,316
- iOS:     weekend avg ₹1,314 | weekday avg ₹1,303  (iOS higher on weekends)
- Web:     weekend avg ₹1,297 | weekday avg ₹1,302
NETWORKS: 4G 59.9% | 5G 25.0% | WiFi 10.1% | 3G 5.0%
TOP BANKS: SBI 62,693 | HDFC 37,485 | ICICI 29,769
AGE GROUPS: 26-35 (34.97%) | 36-45 (25.15%) | 18-25 (24.94%) | 46-55 (9.94%) | 56+ (5.00%)

FRAUD RATES: By category: Transport 0.214% | Education 0.211% | Shopping 0.208% | Food 0.195% | Utilities 0.148% (lowest)
By state: Karnataka 0.232% | Rajasthan 0.23% | Gujarat 0.214% | Tamil Nadu 0.158% (lowest)
By network: WiFi 0.235% (highest!) | 5G 0.184% (lowest)
By bank: Kotak 0.25% | ICICI 0.222% | Yes Bank 0.161% (lowest)
By age: 18-25 0.229% | 46-55 0.125% (lowest)
By type: Recharge 0.239% | P2P 0.183% (lowest)

FAILURE RATES: Education 5.25% | Shopping 5.09% | Transport 4.76% (lowest)
PEAK ACTIVITY: 7 PM busiest (21,232 txns) | 4 AM quietest (1,247 txns) | Evening surge 5–8 PM
WEEKEND vs WEEKDAY: Max weekend ₹42,099 | Max weekday ₹37,263 | Avg similar ~₹1,310

RESPONSE FORMAT:
1. **Direct Answer** — precise, with the exact number asked for
2. **Key Numbers** — supporting stats
3. **Pattern** — why it matters
4. **Business Recommendation** — 1 actionable insight

Use ₹ for amounts, % for rates. Be confident and concise. You have individual-record-level data (top 10 shown) plus full aggregate stats across all dimensions.`;

// ── SAMPLE QUERIES ────────────────────────────────────────────────────────────
const SAMPLE_QUERIES = [
  "What is the highest individual transaction amount?",
  "Show me the top 10 largest transactions",
  "What is the transaction amount distribution?",
  "Which merchant category has the highest fraud risk?",
  "What are peak transaction hours?",
  "Compare fraud rates across different states",
  "Which bank has the highest max transaction?",
  "Show me the age group spending patterns",
  "Give me an executive summary of the dataset",
  "What is the fraud amount pattern?",
  "Which state has the highest single transaction?",
  "How many transactions are above ₹10,000?",
  "What's the median transaction by category?",
  "Compare P2P vs P2M transaction patterns",
  "Compare average transaction amounts for iOS vs Android",
  "Which device type has the highest average transaction amount?",
  "Show device performance breakdown",
  "What's the WiFi network fraud anomaly?",
];

// ── CHART COMPONENTS ──────────────────────────────────────────────────────────
const CustomTooltip = ({ active, payload, label, prefix = "", suffix = "" }) => {
  if (active && payload && payload.length) {
    return (
      <div style={{ 
        background: "#ffffff", 
        border: `1px solid ${THEME.border}`, 
        boxShadow: "0 4px 12px rgba(0,0,0,0.08)",
        borderRadius: 8, 
        padding: "10px 14px",
        minWidth: "120px"
      }}>
        <p style={{ color: THEME.textSecondary, fontSize: 11, margin: "0 0 6px 0", fontWeight: 600, textTransform: "uppercase", letterSpacing: 0.5 }}>{label}</p>
        {payload.map((p, i) => (
          <p key={i} style={{ color: p.color || THEME.textPrimary, fontSize: 13, margin: "2px 0", fontWeight: 600, display: "flex", justifyContent: "space-between", gap: 12 }}>
            <span>{p.name || "Value"}:</span>
            <span>{prefix}{typeof p.value === 'number' && p.value > 100 ? fmtNum(p.value) : p.value}{suffix}</span>
          </p>
        ))}
      </div>
    );
  }
  return null;
};

// ── MAIN APP ──────────────────────────────────────────────────────────────────
export default function InsightXApp() {
  const [messages, setMessages] = useState([
    {
      role: "assistant",
      content: "Welcome to **InsightX AI** — your conversational intelligence layer for 250,000 UPI transactions across India in 2026.\n\nI can answer questions about fraud patterns, transaction volumes, peak hours, state-wise analytics, bank performance, and much more. Try asking something or use the sample queries below.",
      chart: null,
      confidence: null,
    }
  ]);
  const [input, setInput] = useState("");
  const [loading, setLoading] = useState(false);
  const [activeTab, setActiveTab] = useState("chat");
  const [conversationHistory, setConversationHistory] = useState([]);
  const chatEndRef = useRef(null);
  const inputRef = useRef(null);

  useEffect(() => {
    chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [messages, loading]);

  const detectChartType = (query, answer) => {
    const q = query.toLowerCase();
    if (q.includes("highest") || q.includes("largest") || q.includes("maximum") || q.includes("biggest") || q.includes("top 10") || q.includes("distribution") || q.includes("bucket") || q.includes("range")) return "amountdist";
    if (q.includes("hour") || q.includes("peak") || q.includes("time")) return "hourly";
    if (q.includes("state") || q.includes("region")) return "state";
    if (q.includes("categor") || q.includes("merchant")) return "category";
    if (q.includes("device") || q.includes("ios") || q.includes("android") || q.includes("web browser") || q.includes("compare device") || q.includes("device avg") || q.includes("device amount") || q.includes("device compar")) return "device_compare";
    if (q.includes("network") || q.includes("4g") || q.includes("5g") || q.includes("wifi")) return "network";
    if (q.includes("bank") || q.includes("sbi") || q.includes("hdfc") || q.includes("icici")) return "bank";
    if (q.includes("day") || q.includes("week") || q.includes("monday")) return "daily";
    if (q.includes("age") || q.includes("young") || q.includes("senior")) return "age";
    if (q.includes("type") || q.includes("p2p") || q.includes("p2m")) return "txtype";
    if (q.includes("fraud")) return "fraud_overview";
    if (q.includes("volume") || q.includes("summary") || q.includes("overview")) return "category";
    return null;
  };

  const computeConfidence = (query) => {
    const q = query.toLowerCase();
    const knownTopics = ["fraud", "volume", "transaction", "peak", "state", "category", "device", "network", "bank", "age", "amount", "fail", "success", "merchant"];
    const matches = knownTopics.filter(t => q.includes(t)).length;
    if (matches >= 3) return { score: 96, label: "High" };
    if (matches >= 2) return { score: 89, label: "High" };
    if (matches >= 1) return { score: 78, label: "Medium" };
    return { score: 65, label: "Medium" };
  };

  const sendMessage = async (text) => {
    const userText = text || input.trim();
    if (!userText) return;
    setInput("");

    const userMsg = { role: "user", content: userText };
    const updatedHistory = [...conversationHistory, { role: "user", content: userText }];

    setMessages(prev => [...prev, { role: "user", content: userText }]);
    setLoading(true);

    try {
      const response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 1000,
          system: buildSystemPrompt(),
          messages: updatedHistory,
        }),
      });
      const data = await response.json();
      const aiText = data.content?.map(c => c.text || "").join("") || "I couldn't process that query. Please try again.";

      const chartType = detectChartType(userText, aiText);
      const confidence = computeConfidence(userText);

      const assistantMsg = { role: "assistant", content: aiText };
      setConversationHistory([...updatedHistory, { role: "assistant", content: aiText }]);
      setMessages(prev => [...prev, { role: "assistant", content: aiText, chart: chartType, confidence }]);
    } catch (err) {
      setMessages(prev => [...prev, { role: "assistant", content: "⚠️ API connection error. Please check your network and try again.", chart: null, confidence: null }]);
    }
    setLoading(false);
  };

  const renderChart = (type) => {
    if (!type) return null;
    
    // Unified Card Style for Charts in Chat
    const chartCardStyle = {
      background: THEME.surface,
      border: `1px solid ${THEME.border}`,
      borderRadius: 12,
      padding: "16px",
      marginTop: 12,
      boxShadow: "0 2px 4px rgba(0,0,0,0.02)"
    };

    const titleStyle = {
      fontSize: 12,
      color: THEME.textSecondary,
      margin: "0 0 12px 0",
      letterSpacing: 0.5,
      fontWeight: 700,
      textTransform: "uppercase"
    };

    switch (type) {
      case "amountdist":
        return (
          <div style={chartCardStyle}>
            <p style={titleStyle}>Transaction Amount Distribution & Top 10</p>
            <ResponsiveContainer width="100%" height={180}>
              <BarChart data={Object.entries(DATA.amount_buckets).map(([k, v]) => ({ range: k, count: v }))} margin={{ top: 10, right: 10, bottom: 0, left: -10 }}>
                <CartesianGrid strokeDasharray="4 4" stroke={THEME.chartGrid} vertical={false} />
                <XAxis dataKey="range" tick={{ fill: THEME.chartText, fontSize: 11 }} axisLine={false} tickLine={false} />
                <YAxis tick={{ fill: THEME.chartText, fontSize: 11 }} axisLine={false} tickLine={false} />
                <Tooltip content={<CustomTooltip />} cursor={{fill: THEME.blueSoft}} />
                <Bar dataKey="count" radius={[6, 6, 0, 0]}>
                  {Object.keys(DATA.amount_buckets).map((_, i) => <Cell key={i} fill={COLORS[i]} />)}
                </Bar>
              </BarChart>
            </ResponsiveContainer>
            <div style={{ marginTop: 16, fontSize: 11, color: THEME.textSecondary, fontWeight: 700, marginBottom: 8 }}>TOP 10 HIGHEST TRANSACTIONS</div>
            <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
              {DATA.top10_amounts.map((t, i) => (
                <div key={i} style={{ 
                  display: "flex", 
                  justifyContent: "space-between", 
                  alignItems: "center", 
                  padding: "8px 12px", 
                  background: THEME.bg, 
                  borderRadius: 8, 
                  border: `1px solid ${THEME.border}`,
                  fontSize: 12
                }}>
                  <span style={{ color: THEME.blue, fontWeight: 700, minWidth: 80 }}>₹{t.amount.toLocaleString()}</span>
                  <span style={{ color: THEME.textPrimary, fontWeight: 500 }}>{t.category}</span>
                  <span style={{ color: THEME.textSecondary, fontSize: 11 }}>{t.type}</span>
                  <span style={{ color: THEME.textSecondary, fontSize: 11 }}>{t.state}</span>
                  <span style={{ 
                    fontSize: 10, 
                    padding: "2px 8px", 
                    borderRadius: 12, 
                    background: t.status === "SUCCESS" ? THEME.success + "15" : THEME.danger + "15", 
                    color: t.status === "SUCCESS" ? THEME.success : THEME.danger,
                    fontWeight: 600,
                    marginLeft: 8
                  }}>{t.status}</span>
                </div>
              ))}
            </div>
          </div>
        );
      case "hourly":
        return (
          <div style={chartCardStyle}>
            <p style={titleStyle}>Transaction Volume by Hour (₹M)</p>
            <ResponsiveContainer width="100%" height={200}>
              <AreaChart data={hourlyChartData} margin={{ top: 10, right: 10, bottom: 0, left: -10 }}>
                <defs>
                  <linearGradient id="hg" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="5%" stopColor={THEME.blue} stopOpacity={0.2} />
                    <stop offset="95%" stopColor={THEME.blue} stopOpacity={0} />
                  </linearGradient>
                </defs>
                <CartesianGrid strokeDasharray="4 4" stroke={THEME.chartGrid} vertical={false} />
                <XAxis dataKey="hour" tick={{ fill: THEME.chartText, fontSize: 11 }} interval={3} axisLine={false} tickLine={false} />
                <YAxis tick={{ fill: THEME.chartText, fontSize: 11 }} axisLine={false} tickLine={false} />
                <Tooltip content={<CustomTooltip prefix="₹" suffix="M" />} cursor={{fill: THEME.blueSoft}} />
                <Area type="monotone" dataKey="volume" stroke={THEME.blue} fill="url(#hg)" strokeWidth={2} dot={false} />
              </AreaChart>
            </ResponsiveContainer>
          </div>
        );
      case "state":
        return (
          <div style={chartCardStyle}>
            <p style={titleStyle}>Transaction Volume by State (₹M)</p>
            <ResponsiveContainer width="100%" height={200}>
              <BarChart data={stateChartData} margin={{ top: 10, right: 10, bottom: 0, left: -10 }}>
                <CartesianGrid strokeDasharray="4 4" stroke={THEME.chartGrid} vertical={false} />
                <XAxis dataKey="state" tick={{ fill: THEME.chartText, fontSize: 10 }} axisLine={false} tickLine={false} />
                <YAxis tick={{ fill: THEME.chartText, fontSize: 11 }} axisLine={false} tickLine={false} />
                <Tooltip content={<CustomTooltip prefix="₹" suffix="M" />} cursor={{fill: THEME.blueSoft}} />
                <Bar dataKey="vol" fill={THEME.blueLight} radius={[4, 4, 0, 0]} />
              </BarChart>
            </ResponsiveContainer>
          </div>
        );
      case "category":
        return (
          <div style={chartCardStyle}>
            <p style={titleStyle}>Transactions by Merchant Category</p>
            <ResponsiveContainer width="100%" height={200}>
              <BarChart data={catChartData} margin={{ top: 10, right: 10, bottom: 0, left: -10 }}>
                <CartesianGrid strokeDasharray="4 4" stroke={THEME.chartGrid} vertical={false} />
                <XAxis dataKey="name" tick={{ fill: THEME.chartText, fontSize: 10 }} axisLine={false} tickLine={false} />
                <YAxis tick={{ fill: THEME.chartText, fontSize: 11 }} axisLine={false} tickLine={false} />
                <Tooltip content={<CustomTooltip />} cursor={{fill: THEME.blueSoft}} />
                <Bar dataKey="txns" radius={[4, 4, 0, 0]}>
                  {catChartData.map((_, i) => <Cell key={i} fill={COLORS[i % COLORS.length]} />)}
                </Bar>
              </BarChart>
            </ResponsiveContainer>
          </div>
        );
      case "device":
      case "device_compare":
        return (
          <div style={chartCardStyle}>
            <p style={titleStyle}>Device Comparison — Avg Amount (₹) by Category</p>
            <ResponsiveContainer width="100%" height={220}>
              <BarChart
                data={Object.entries(DATA.device_cat_avg).map(([cat, vals]) => ({ cat, Android: vals.Android, iOS: vals.iOS, Web: vals.Web }))}
                margin={{ top: 10, right: 10, bottom: 10, left: -10 }}
              >
                <CartesianGrid strokeDasharray="4 4" stroke={THEME.chartGrid} vertical={false} />
                <XAxis dataKey="cat" tick={{ fill: THEME.chartText, fontSize: 9 }} angle={-20} textAnchor="end" axisLine={false} tickLine={false} />
                <YAxis tick={{ fill: THEME.chartText, fontSize: 10 }} axisLine={false} tickLine={false} />
                <Tooltip content={<CustomTooltip prefix="₹" />} cursor={{fill: THEME.blueSoft}} />
                <Bar dataKey="Android" fill={THEME.blue} radius={[2, 2, 0, 0]} />
                <Bar dataKey="iOS" fill={THEME.blueLight} radius={[2, 2, 0, 0]} />
                <Bar dataKey="Web" fill={THEME.accent} radius={[2, 2, 0, 0]} />
              </BarChart>
            </ResponsiveContainer>
            <div style={{ display: "flex", gap: 20, justifyContent: "center", marginTop: 10, paddingTop: 10, borderTop: `1px solid ${THEME.border}` }}>
              {[["Android", THEME.blue, "₹1,313.98"], ["iOS", THEME.blueLight, "₹1,306.10"], ["Web", THEME.accent, "₹1,300.81"]].map(([d, c, a]) => (
                <div key={d} style={{ display: "flex", alignItems: "center", gap: 8, fontSize: 12 }}>
                  <div style={{ width: 10, height: 10, borderRadius: "50%", background: c }} />
                  <span style={{ color: THEME.textSecondary, fontWeight: 500 }}>{d}</span>
                  <span style={{ color: THEME.textPrimary, fontWeight: 700 }}>{a}</span>
                </div>
              ))}
            </div>
            <div style={{ marginTop: 16, display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 10 }}>
              {[
                { label: "Fraud Rate", Android: "0.194%", iOS: "0.181% ✓", Web: "0.206%", best: "iOS" },
                { label: "Success Rate", Android: "95.06%", iOS: "95.07% ✓", Web: "94.85%", best: "iOS" },
                { label: "Max Txn", Android: "₹42,099", iOS: "₹30,351", Web: "₹27,541", best: "Android" },
              ].map((row, i) => (
                <div key={i} style={{ 
                  background: THEME.bg, 
                  borderRadius: 8, 
                  padding: "12px", 
                  border: `1px solid ${THEME.border}` 
                }}>
                  <div style={{ fontSize: 10, color: THEME.textSecondary, fontWeight: 700, letterSpacing: 0.5, marginBottom: 8 }}>{row.label}</div>
                  {[["Android", THEME.blue, row.Android], ["iOS", THEME.blueLight, row.iOS], ["Web", THEME.accent, row.Web]].map(([d, c, v]) => (
                    <div key={d} style={{ display: "flex", justifyContent: "space-between", fontSize: 11, marginBottom: 3, color: THEME.textSecondary }}>
                      <span style={{ fontWeight: 500 }}>{d}</span>
                      <span style={{ color: c, fontWeight: 700 }}>{v}</span>
                    </div>
                  ))}
                </div>
              ))}
            </div>
          </div>
        );
      case "network":
        return (
          <div style={chartCardStyle}>
            <p style={titleStyle}>Network Type Distribution & Fraud Rate</p>
            <ResponsiveContainer width="100%" height={200}>
              <BarChart data={Object.entries(DATA.networks).map(([k, v]) => ({ name: k, txns: v, fraud: DATA.network_fraud[k] || 0 }))} margin={{ top: 10, right: 10, bottom: 0, left: -10 }}>
                <CartesianGrid strokeDasharray="4 4" stroke={THEME.chartGrid} vertical={false} />
                <XAxis dataKey="name" tick={{ fill: THEME.chartText, fontSize: 11 }} axisLine={false} tickLine={false} />
                <YAxis yAxisId="left" tick={{ fill: THEME.chartText, fontSize: 10 }} axisLine={false} tickLine={false} />
                <YAxis yAxisId="right" orientation="right" tick={{ fill: THEME.chartText, fontSize: 10 }} axisLine={false} tickLine={false} />
                <Tooltip />
                <Bar yAxisId="left" dataKey="txns" fill={THEME.blue} radius={[4, 4, 0, 0]} />
                <Bar yAxisId="right" dataKey="fraud" fill={THEME.danger} radius={[4, 4, 0, 0]} name="Fraud%" />
              </BarChart>
            </ResponsiveContainer>
          </div>
        );
      case "bank":
        return (
          <div style={chartCardStyle}>
            <p style={titleStyle}>Bank — Transactions & Fraud Rate</p>
            <ResponsiveContainer width="100%" height={200}>
              <BarChart data={bankChartData} margin={{ top: 10, right: 10, bottom: 0, left: -10 }}>
                <CartesianGrid strokeDasharray="4 4" stroke={THEME.chartGrid} vertical={false} />
                <XAxis dataKey="bank" tick={{ fill: THEME.chartText, fontSize: 10 }} axisLine={false} tickLine={false} />
                <YAxis tick={{ fill: THEME.chartText, fontSize: 10 }} axisLine={false} tickLine={false} />
                <Tooltip cursor={{fill: THEME.blueSoft}} />
                <Bar dataKey="txns" fill={THEME.success} radius={[4, 4, 0, 0]} />
              </BarChart>
            </ResponsiveContainer>
          </div>
        );
      case "daily":
        return (
          <div style={chartCardStyle}>
            <p style={titleStyle}>Daily Transaction Count by Day of Week</p>
            <ResponsiveContainer width="100%" height={200}>
              <BarChart data={dailyChartData} margin={{ top: 10, right: 10, bottom: 0, left: -10 }}>
                <CartesianGrid strokeDasharray="4 4" stroke={THEME.chartGrid} vertical={false} />
                <XAxis dataKey="day" tick={{ fill: THEME.chartText, fontSize: 11 }} axisLine={false} tickLine={false} />
                <YAxis tick={{ fill: THEME.chartText, fontSize: 10 }} axisLine={false} tickLine={false} />
                <Tooltip content={<CustomTooltip />} cursor={{fill: THEME.blueSoft}} />
                <Bar dataKey="txns" fill={THEME.warning} radius={[4, 4, 0, 0]} />
              </BarChart>
            </ResponsiveContainer>
          </div>
        );
      case "age":
        return (
          <div style={chartCardStyle}>
            <p style={titleStyle}>Age Group — Transactions & Avg Amount (₹)</p>
            <ResponsiveContainer width="100%" height={200}>
              <BarChart data={Object.entries(DATA.age_groups).map(([k, v]) => ({ age: k, txns: v, avg: DATA.age_avg[k], fraud: DATA.age_fraud[k] }))} margin={{ top: 10, right: 10, bottom: 0, left: -10 }}>
                <CartesianGrid strokeDasharray="4 4" stroke={THEME.chartGrid} vertical={false} />
                <XAxis dataKey="age" tick={{ fill: THEME.chartText, fontSize: 10 }} axisLine={false} tickLine={false} />
                <YAxis tick={{ fill: THEME.chartText, fontSize: 10 }} axisLine={false} tickLine={false} />
                <Tooltip cursor={{fill: THEME.blueSoft}} />
                <Bar dataKey="txns" fill="#8b5cf6" radius={[4, 4, 0, 0]} />
              </BarChart>
            </ResponsiveContainer>
          </div>
        );
      case "txtype":
        return (
          <div style={chartCardStyle}>
            <p style={titleStyle}>Transaction Types — Volume & Fraud Rate</p>
            <ResponsiveContainer width="100%" height={200}>
              <BarChart data={fraudByType} margin={{ top: 10, right: 10, bottom: 0, left: -10 }}>
                <CartesianGrid strokeDasharray="4 4" stroke={THEME.chartGrid} vertical={false} />
                <XAxis dataKey="type" tick={{ fill: THEME.chartText, fontSize: 10 }} axisLine={false} tickLine={false} />
                <YAxis tick={{ fill: THEME.chartText, fontSize: 10 }} axisLine={false} tickLine={false} />
                <Tooltip cursor={{fill: THEME.blueSoft}} />
                <Bar dataKey="avg" fill="#06b6d4" radius={[4, 4, 0, 0]} name="Avg ₹" />
              </BarChart>
            </ResponsiveContainer>
          </div>
        );
      case "fraud_overview":
        return (
          <div style={chartCardStyle}>
            <p style={titleStyle}>Fraud Rate by Category (%)</p>
            <ResponsiveContainer width="100%" height={200}>
              <BarChart data={Object.entries(DATA.cat_fraud).map(([k, v]) => ({ cat: k, rate: v })).sort((a, b) => b.rate - a.rate)} margin={{ top: 10, right: 10, bottom: 0, left: -10 }}>
                <CartesianGrid strokeDasharray="4 4" stroke={THEME.chartGrid} vertical={false} />
                <XAxis dataKey="cat" tick={{ fill: THEME.chartText, fontSize: 9 }} axisLine={false} tickLine={false} />
                <YAxis tick={{ fill: THEME.chartText, fontSize: 10 }} axisLine={false} tickLine={false} />
                <Tooltip content={<CustomTooltip suffix="%" />} cursor={{fill: THEME.blueSoft}} />
                <Bar dataKey="rate" fill={THEME.danger} radius={[4, 4, 0, 0]} />
              </BarChart>
            </ResponsiveContainer>
          </div>
        );
      default: return null;
    }
  };

  const renderMarkdown = (text) => {
    const parts = text.split(/(\*\*[^*]+\*\*)/g);
    return parts.map((part, i) => {
      if (part.startsWith("**") && part.endsWith("**")) {
        return <strong key={i} style={{ color: THEME.textPrimary, fontWeight: 700 }}>{part.slice(2, -2)}</strong>;
      }
      return <span key={i} style={{ lineHeight: 1.7 }}>{part}</span>;
    });
  };

  // ── STYLES ──
  const styles = {
    app: { 
      fontFamily: "'Inter', 'Segoe UI', sans-serif",
      background: THEME.bg,
      color: THEME.textPrimary,
      minHeight: "100vh",
      display: "flex",
      flexDirection: "column"
    },
    header: {
        background: THEME.surface,
        borderBottom: `1px solid ${THEME.border}`,
        padding: "0 32px",
        display: "flex",
        alignItems: "center",
        justifyContent: "space-between",
        height: 64,
        boxShadow: "0 1px 3px rgba(0,0,0,0.05)",
        position: "sticky",
        top: 0,
        zIndex: 10
      },
    logo: { display: "flex", alignItems: "center", gap: 12 },
    logoIcon: {
      width: 36,
      height: 36,
      background: THEME.gradient,
      borderRadius: 10,
      display: "flex",
      alignItems: "center",
      justifyContent: "center",
      color: "#fff",
      fontSize: 18,
      boxShadow: "0 4px 12px rgba(37, 99, 235, 0.25)"
    },
    logoText: {
      fontSize: 22,
      fontWeight: 800,
      color: THEME.blue,
      letterSpacing: -0.5
    },
    sendBtn: {
      background: THEME.gradient,
      border: "none",
      borderRadius: 8,
      padding: "12px 20px",
      color: "#fff",
      fontWeight: 600,
      cursor: "pointer",
      fontSize: 14,
      boxShadow: "0 2px 6px rgba(37, 99, 235, 0.2)",
      transition: "all 0.2s",
    },
    tabs: { display: "flex", gap: 4, background: "transparent" },
    tab: (active) => ({ 
      padding: "8px 20px", 
      fontSize: 13, 
      fontWeight: 600, 
      cursor: "pointer", 
      border: "none", 
      background: "transparent", 
      color: active ? THEME.blue : THEME.textSecondary, 
      borderBottom: active ? `2px solid ${THEME.blue}` : "2px solid transparent", 
      transition: "all 0.2s",
      position: "relative",
      top: 1
    }),
    body: { display: "flex", flex: 1, overflow: "hidden", height: "calc(100vh - 64px)" },
    // chat panel
    chatPanel: { flex: 1, display: "flex", flexDirection: "column", overflow: "hidden", background: THEME.bg },
    messages: { flex: 1, overflowY: "auto", padding: "24px", display: "flex", flexDirection: "column", gap: 20 },
    
    aiBubble: {
      alignSelf: "flex-start",
      background: THEME.surface,
      border: `1px solid ${THEME.border}`,
      borderRadius: "0 12px 12px 12px",
      padding: "16px 20px",
      maxWidth: "90%",
      fontSize: 14,
      lineHeight: 1.7,
      color: THEME.textPrimary,
      boxShadow: "0 2px 8px rgba(0,0,0,0.04)"
    },
    
    userBubble: {
      alignSelf: "flex-end",
      background: THEME.gradient,
      color: "#fff",
      borderRadius: "12px 12px 0 12px",
      padding: "12px 18px",
      maxWidth: "80%",
      fontSize: 14,
      boxShadow: "0 4px 12px rgba(37, 99, 235, 0.25)",
      fontWeight: 500
    },

    aiLabel: { 
      fontSize: 10, 
      color: THEME.blue, 
      fontWeight: 800, 
      letterSpacing: 1, 
      marginBottom: 8, 
      display: "flex", 
      alignItems: "center", 
      justifyContent: "space-between" 
    },
    confidenceBadge: (score) => ({ 
      fontSize: 9, 
      padding: "2px 8px", 
      borderRadius: 12, 
      background: score >= 90 ? THEME.success + "15" : score >= 75 ? THEME.warning + "15" : THEME.danger + "15", 
      color: score >= 90 ? THEME.success : score >= 75 ? THEME.warning : THEME.danger, 
      fontWeight: 700
    }),
    loadingBubble: { 
      alignSelf: "flex-start", 
      background: THEME.surface, 
      border: `1px solid ${THEME.border}`,
      borderRadius: "0 12px 12px 12px", 
      padding: "16px 20px" 
    },
    
    inputArea: {
      padding: "20px 24px",
      borderTop: `1px solid ${THEME.border}`,
      background: THEME.surface,
    },

    input: {
      flex: 1,
      background: THEME.bg,
      border: `1px solid ${THEME.border}`,
      borderRadius: 8,
      padding: "12px 16px",
      color: THEME.textPrimary,
      fontSize: 14,
      outline: "none",
      transition: "border-color 0.2s"
    },
    
    quickQueries: { display: "flex", gap: 8, overflowX: "auto", paddingBottom: 12, marginBottom: 8 },
    inputRow: { display: "flex", gap: 12 },
    quickBtn: {
      fontSize: 11,
      whiteSpace: "nowrap",
      padding: "6px 12px",
      borderRadius: 20,
      background: THEME.surface,
      border: `1px solid ${THEME.border}`,
      color: THEME.textSecondary,
      cursor: "pointer",
      fontWeight: 500,
      transition: "all 0.2s"
    },
    
    // dashboard panel
    dashboard: { 
      flex: 1, 
      overflowY: "auto", 
      padding: 32, 
      display: "grid", 
      gridTemplateColumns: "repeat(4, 1fr)", 
      gap: 24, 
      alignContent: "start",
      background: THEME.bg
    },
    kpiCard: {
      background: THEME.surface,
      border: `1px solid ${THEME.border}`,
      borderRadius: 16,
      padding: 20,
      boxShadow: "0 4px 6px -1px rgba(0, 0, 0, 0.05)",
      transition: "transform 0.2s",
      gridColumn: "span 1"
    },
    chartCard: {
      background: THEME.surface,
      border: `1px solid ${THEME.border}`,
      borderRadius: 16,
      padding: 20,
      boxShadow: "0 4px 6px -1px rgba(0, 0, 0, 0.05)",
      gridColumn: "span 2"
    },
    fullCard: {
      background: THEME.surface,
      border: `1px solid ${THEME.border}`,
      borderRadius: 16,
      padding: 24,
      boxShadow: "0 4px 6px -1px rgba(0, 0, 0, 0.05)",
      gridColumn: "span 4"
    },
    sectionTitle: { fontSize: 12, fontWeight: 700, color: THEME.textSecondary, letterSpacing: 1, marginBottom: 12, textTransform: "uppercase" },
  };

  const LoadingDots = () => (
    <div style={{ display: "flex", gap: 4, alignItems: "center", height: 20 }}>
      {[0, 1, 2].map(i => (
        <div key={i} style={{ 
          width: 6, 
          height: 6, 
          borderRadius: "50%", 
          background: THEME.blue, 
          animation: "pulse 1.4s infinite ease-in-out", 
          animationDelay: `${i * 0.16}s` 
        }} />
      ))}
      <style>{`@keyframes pulse{0%,80%,100%{transform:scale(0.8);opacity:0.5}40%{transform:scale(1.2);opacity:1}}`}</style>
    </div>
  );

  return (
    <div style={styles.app}>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        *{box-sizing:border-box;scrollbar-width:thin;scrollbar-color:#cbd5e1 #f1f5f9}
        *::-webkit-scrollbar{width:6px;height:6px}
        *::-webkit-scrollbar-track{background:#f1f5f9}
        *::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:4px}
        *::-webkit-scrollbar-thumb:hover{background:#94a3b8}
        input::placeholder{color:#94a3b8}
        .qbtn:hover{border-color:${THEME.blue}!important;color:${THEME.blue}!important;background:${THEME.blueSoft}!important;transform: translateY(-1px)}
        .sndbtn:hover{opacity:0.9;transform: translateY(-1px)}
        .dash-card:hover{transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05); border-color: ${THEME.blueSoft};}
      `}</style>

      {/* HEADER with nav */}
      <div style={styles.header}>
        <div style={styles.logo}>
          <div style={styles.logoIcon}>⚡</div>
          <div>
            <div style={styles.logoText}>InsightX AI</div>
          </div>
        </div>

        {/* NAV LINKS in header */}
        <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
          {[
            { id: "chat", label: "💬 Chat", },
            { id: "dashboard", label: "📊 Dashboard", },
          ].map(({ id, label }) => (
            <button
              key={id}
              onClick={() => setActiveTab(id)}
              style={styles.tab(activeTab === id)}
            >
              {label}
            </button>
          ))}
        </div>
      </div>

      {/* BODY */}
      <div style={styles.body}>
        {activeTab === "chat" ? (
          <>
            {/* CHAT PANEL — full width */}
            <div style={styles.chatPanel}>
              <div style={styles.messages}>
                {messages.map((m, i) => (
                  <div key={i}>
                    {m.role === "user" ? (
                      <div style={styles.userBubble}>{m.content}</div>
                    ) : (
                      <div style={styles.aiBubble}>
                        <div style={styles.aiLabel}>
                          <span>INSIGHTX AI</span>
                          {m.confidence && (
                            <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                              <span style={styles.confidenceBadge(m.confidence.score)}>
                                {m.confidence.score}% CONFIDENCE
                              </span>
                            </div>
                          )}
                        </div>
                        <div>{renderMarkdown(m.content)}</div>
                        {m.chart && renderChart(m.chart)}
                      </div>
                    )}
                  </div>
                ))}
                {loading && (
                  <div style={styles.loadingBubble}>
                    <div style={styles.aiLabel}>INSIGHTX AI</div>
                    <LoadingDots />
                  </div>
                )}
                <div ref={chatEndRef} />
              </div>

              {/* INPUT AREA */}
              <div style={styles.inputArea}>
                <div style={styles.quickQueries}>
                  {SAMPLE_QUERIES.slice(0, 8).map((q, i) => (
                    <button key={i} className="qbtn" style={styles.quickBtn} onClick={() => sendMessage(q)}>{q}</button>
                  ))}
                </div>
                <div style={styles.inputRow}>
                  <input
                    ref={inputRef}
                    style={styles.input}
                    value={input}
                    onChange={e => setInput(e.target.value)}
                    onKeyDown={e => e.key === "Enter" && !e.shiftKey && sendMessage()}
                    placeholder="Ask anything about UPI transactions… e.g. 'Which state has the highest fraud rate?'"
                  />
                  <button className="sndbtn" style={styles.sendBtn} onClick={() => sendMessage()} disabled={loading}>
                    {loading ? "…" : "Send"}
                  </button>
                </div>
              </div>
            </div>
          </>
        ) : (
          /* FULL DASHBOARD VIEW */
          <div style={styles.dashboard}>
            
            {/* KPIs Row */}
            {[
              { val: "250,000", label: "Total Transactions", color: THEME.blue, icon: "💳" },
              { val: "₹32.79 Cr", label: "Total Volume", color: "#6366f1", icon: "💰" },
              { val: "₹1,311.76", label: "Average Transaction", color: "#0ea5e9", icon: "📊" },
              { val: "95.05%", label: "Success Rate", color: THEME.success, icon: "✅" },
              { val: "480", label: "Fraud Cases", color: THEME.danger, icon: "🚨" },
              { val: "0.192%", label: "Fraud Rate", color: "#f97316", icon: "⚠️" },
              { val: "7 PM", label: "Peak Hour", color: "#8b5cf6", icon: "⏰" },
              { val: "Maharashtra", label: "Top State", color: "#14b8a6", icon: "📍" },
            ].map((k, i) => (
              <div key={i} className="dash-card" style={styles.kpiCard}>
                <div style={{ fontSize: 24, marginBottom: 12, opacity: 0.8 }}>{k.icon}</div>
                <div style={{ fontSize: 24, fontWeight: 700, color: THEME.textPrimary, marginBottom: 4 }}>{k.val}</div>
                <div style={{ fontSize: 12, color: THEME.textSecondary, fontWeight: 500 }}>{k.label}</div>
                <div style={{ height: 3, width: 40, background: k.color, marginTop: 12, borderRadius: 2 }}></div>
              </div>
            ))}

            {/* Hourly Volume */}
            <div className="dash-card" style={styles.fullCard}>
              <p style={styles.sectionTitle}>Transaction Volume by Hour (₹M)</p>
              <ResponsiveContainer width="100%" height={250}>
                <AreaChart data={hourlyChartData} margin={{ top: 10, right: 20, bottom: 0, left: 0 }}>
                  <defs>
                    <linearGradient id="gh3" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="5%" stopColor={THEME.blue} stopOpacity={0.3} />
                      <stop offset="95%" stopColor={THEME.blue} stopOpacity={0} />
                    </linearGradient>
                  </defs>
                  <CartesianGrid strokeDasharray="4 4" stroke={THEME.chartGrid} vertical={false} />
                  <XAxis dataKey="hour" tick={{ fill: THEME.chartText, fontSize: 11 }} axisLine={false} tickLine={false} />
                  <YAxis tick={{ fill: THEME.chartText, fontSize: 11 }} axisLine={false} tickLine={false} />
                  <Tooltip content={<CustomTooltip prefix="₹" suffix="M" />} cursor={{fill: THEME.blueSoft}} />
                  <Area type="monotone" dataKey="volume" stroke={THEME.blue} fill="url(#gh3)" strokeWidth={2.5} dot={false} />
                </AreaChart>
              </ResponsiveContainer>
            </div>

            {/* Category chart */}
            <div className="dash-card" style={styles.chartCard}>
              <p style={styles.sectionTitle}>Transactions by Category</p>
              <ResponsiveContainer width="100%" height={220}>
                <BarChart data={catChartData} margin={{ top: 10, right: 10, bottom: 10, left: 0 }}>
                  <CartesianGrid strokeDasharray="4 4" stroke={THEME.chartGrid} vertical={false} />
                  <XAxis dataKey="name" tick={{ fill: THEME.chartText, fontSize: 10 }} angle={-30} textAnchor="end" axisLine={false} tickLine={false} />
                  <YAxis tick={{ fill: THEME.chartText, fontSize: 10 }} axisLine={false} tickLine={false} />
                  <Tooltip content={<CustomTooltip />} cursor={{fill: THEME.blueSoft}} />
                  <Bar dataKey="txns" radius={[4, 4, 0, 0]}>
                    {catChartData.map((_, i) => <Cell key={i} fill={COLORS[i % COLORS.length]} />)}
                  </Bar>
                </BarChart>
              </ResponsiveContainer>
            </div>

            {/* State volume */}
            <div className="dash-card" style={styles.chartCard}>
              <p style={styles.sectionTitle}>Volume by State (₹M)</p>
              <ResponsiveContainer width="100%" height={220}>
                <BarChart data={stateChartData} margin={{ top: 10, right: 10, bottom: 10, left: 0 }}>
                  <CartesianGrid strokeDasharray="4 4" stroke={THEME.chartGrid} vertical={false} />
                  <XAxis dataKey="state" tick={{ fill: THEME.chartText, fontSize: 10 }} angle={-20} textAnchor="end" axisLine={false} tickLine={false} />
                  <YAxis tick={{ fill: THEME.chartText, fontSize: 10 }} axisLine={false} tickLine={false} />
                  <Tooltip content={<CustomTooltip prefix="₹" suffix="M" />} cursor={{fill: THEME.blueSoft}} />
                  <Bar dataKey="vol" fill="#6366f1" radius={[4, 4, 0, 0]} />
                </BarChart>
              </ResponsiveContainer>
            </div>

            {/* Fraud by category */}
            <div className="dash-card" style={styles.chartCard}>
              <p style={styles.sectionTitle}>Fraud Rate by Category (%)</p>
              <ResponsiveContainer width="100%" height={220}>
                <BarChart data={Object.entries(DATA.cat_fraud).map(([k, v]) => ({ cat: k, rate: v })).sort((a, b) => b.rate - a.rate)} margin={{ top: 10, right: 10, bottom: 10, left: 0 }}>
                  <CartesianGrid strokeDasharray="4 4" stroke={THEME.chartGrid} vertical={false} />
                  <XAxis dataKey="cat" tick={{ fill: THEME.chartText, fontSize: 10 }} angle={-20} textAnchor="end" axisLine={false} tickLine={false} />
                  <YAxis tick={{ fill: THEME.chartText, fontSize: 10 }} axisLine={false} tickLine={false} />
                  <Tooltip content={<CustomTooltip suffix="%" />} cursor={{fill: THEME.blueSoft}} />
                  <Bar dataKey="rate" fill={THEME.danger} radius={[4, 4, 0, 0]} />
                </BarChart>
              </ResponsiveContainer>
            </div>

            {/* Device + Network pie */}
            <div className="dash-card" style={{...styles.chartCard, display: "flex", gap: 20 }}>
              <div style={{ flex: 1 }}>
                <p style={styles.sectionTitle}>Device Split</p>
                <ResponsiveContainer width="100%" height={200}>
                  <PieChart>
                    <Pie data={devicePieData} dataKey="value" cx="50%" cy="50%" outerRadius={70} innerRadius={35} label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`} labelLine={false} fontSize={11}>
                      {devicePieData.map((_, i) => <Cell key={i} fill={COLORS[i]} />)}
                    </Pie>
                    <Tooltip />
                  </PieChart>
                </ResponsiveContainer>
              </div>
              <div style={{ flex: 1 }}>
                <p style={styles.sectionTitle}>Network Split</p>
                <ResponsiveContainer width="100%" height={200}>
                  <PieChart>
                    <Pie data={networkPieData} dataKey="value" cx="50%" cy="50%" outerRadius={70} innerRadius={35} label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`} labelLine={false} fontSize={11}>
                      {networkPieData.map((_, i) => <Cell key={i} fill={COLORS[i + 3]} />)}
                    </Pie>
                    <Tooltip />
                  </PieChart>
                </ResponsiveContainer>
              </div>
            </div>

            {/* Avg amount by category */}
            <div className="dash-card" style={styles.chartCard}>
              <p style={styles.sectionTitle}>Avg Transaction by Category (₹)</p>
              <ResponsiveContainer width="100%" height={220}>
                <BarChart data={Object.entries(DATA.cat_avg).map(([k, v]) => ({ cat: k, avg: v })).sort((a, b) => b.avg - a.avg)} margin={{ top: 10, right: 10, bottom: 10, left: 10 }}>
                  <CartesianGrid strokeDasharray="4 4" stroke={THEME.chartGrid} vertical={false} />
                  <XAxis dataKey="cat" tick={{ fill: THEME.chartText, fontSize: 10 }} angle={-20} textAnchor="end" axisLine={false} tickLine={false} />
                  <YAxis tick={{ fill: THEME.chartText, fontSize: 10 }} axisLine={false} tickLine={false} />
                  <Tooltip content={<CustomTooltip prefix="₹" />} cursor={{fill: THEME.blueSoft}} />
                  <Bar dataKey="avg" fill={THEME.warning} radius={[4, 4, 0, 0]} />
                </BarChart>
              </ResponsiveContainer>
            </div>

            {/* Fraud anomaly insight cards */}
            <div className="dash-card" style={styles.fullCard}>
              <p style={styles.sectionTitle}>🚨 Auto-Detected Anomalies & Insights</p>
              <div style={{ display: "grid", gridTemplateColumns: "repeat(3, 1fr)", gap: 16 }}>
                {[
                  { title: "WiFi Fraud Spike", desc: "WiFi transactions show 0.235% fraud rate vs 0.184% on 5G — a 28% relative increase. Likely unauthorized hotspot usage.", color: THEME.danger, icon: "📶" },
                  { title: "Recharge Category Risk", desc: "Recharge transactions have the highest fraud rate at 0.239%, nearly 25% above average. Requires enhanced OTP verification.", color: THEME.danger, icon: "🔋" },
                  { title: "Kotak Bank Alert", desc: "Kotak Bank shows 0.25% fraud rate, the highest among all banks — 30% above the dataset average.", color: THEME.danger, icon: "🏦" },
                  { title: "Youth Vulnerability", desc: "Age group 18-25 shows 0.229% fraud rate. Young users need targeted fraud education and biometric enforcement.", color: THEME.warning, icon: "👤" },
                  { title: "Karnataka Hotspot", desc: "Karnataka has 0.232% fraud rate — highest among all states. Regional investigation and monitoring recommended.", color: THEME.warning, icon: "📍" },
                  { title: "Education High Ticket", desc: "Education category averages ₹5,094/txn — 4x the overall average. High-value target requiring extra scrutiny.", color: THEME.blue, icon: "🎓" },
                ].map((a, i) => (
                  <div key={i} style={{ 
                    background: THEME.bg, 
                    border: `1px solid ${THEME.border}`, 
                    borderRadius: 12, 
                    padding: "16px", 
                    borderLeft: `4px solid ${a.color}`,
                    transition: "all 0.2s"
                  }}>
                    <div style={{ fontSize: 20, marginBottom: 8 }}>{a.icon}</div>
                    <div style={{ fontSize: 13, fontWeight: 700, color: THEME.textPrimary, marginBottom: 6 }}>{a.title}</div>
                    <div style={{ fontSize: 12, color: THEME.textSecondary, lineHeight: 1.6 }}>{a.desc}</div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}